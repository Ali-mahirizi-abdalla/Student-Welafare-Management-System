{% extends 'hms/base.html' %}

{% block title %}Analytics Dashboard{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-xl">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
                <h1
                    class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-purple-600 dark:from-indigo-400 dark:to-purple-400">
                    üìä Analytics Dashboard
                </h1>
                <p class="text-slate-600 dark:text-slate-400 mt-1">Comprehensive insights into system operations</p>
            </div>
            <div class="text-right">
                <p class="text-sm text-slate-500 dark:text-slate-400">Last Updated</p>
                <p class="font-bold text-slate-700 dark:text-slate-300">{{ today|date:"F d, Y" }}</p>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <!-- Total Students -->
        <div class="bg-gradient-to-br from-blue-500 to-cyan-600 p-6 rounded-2xl text-white shadow-xl">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-blue-100 text-sm font-medium">Total Students</p>
                    <p class="text-3xl font-bold">{{ total_students }}</p>
                </div>
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m-3 5.197v-1">
                        </path>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Today's Breakfast -->
        <div class="bg-gradient-to-br from-amber-500 to-orange-600 p-6 rounded-2xl text-white shadow-xl">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-amber-100 text-sm font-medium">Today's Breakfast</p>
                    <p class="text-3xl font-bold">{{ today_breakfast }}</p>
                </div>
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center text-2xl">
                    ‚òÄÔ∏è
                </div>
            </div>
        </div>

        <!-- Today's Supper -->
        <div class="bg-gradient-to-br from-purple-500 to-pink-600 p-6 rounded-2xl text-white shadow-xl">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-purple-100 text-sm font-medium">Today's Supper</p>
                    <p class="text-3xl font-bold">{{ today_supper }}</p>
                </div>
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center text-2xl">
                    üåô
                </div>
            </div>
        </div>

        <!-- Currently Away -->
        <div class="bg-gradient-to-br from-slate-600 to-slate-800 p-6 rounded-2xl text-white shadow-xl">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-slate-300 text-sm font-medium">Currently Away</p>
                    <p class="text-3xl font-bold">{{ today_away }}</p>
                </div>
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center text-2xl">
                    üè†
                </div>
            </div>
        </div>
    </div>

    <!-- Pending Items Alert -->
    {% if pending_maintenance > 0 or pending_leaves > 0 %}
    <div
        class="bg-gradient-to-r from-yellow-50 to-amber-50 dark:from-yellow-900/20 dark:to-amber-900/20 p-6 rounded-2xl border border-yellow-200 dark:border-yellow-800">
        <h3 class="font-semibold text-yellow-800 dark:text-yellow-300 flex items-center gap-2 mb-4">
            <span class="relative flex h-3 w-3">
                <span
                    class="animate-ping absolute inline-flex h-full w-full rounded-full bg-yellow-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-3 w-3 bg-yellow-500"></span>
            </span>
            Action Required
        </h3>
        <div class="flex flex-wrap gap-4">
            {% if pending_maintenance > 0 %}
            <a href="{% url 'hms:manage_maintenance' %}"
                class="flex items-center gap-2 bg-white dark:bg-slate-800 px-4 py-2 rounded-xl shadow hover:shadow-md transition">
                <span class="text-yellow-600 dark:text-yellow-400 font-bold">{{ pending_maintenance }}</span>
                <span class="text-slate-600 dark:text-slate-400">Pending Maintenance</span>
                <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
            </a>
            {% endif %}
            {% if pending_leaves > 0 %}
            <a href="{% url 'hms:manage_leave_requests' %}?status=pending"
                class="flex items-center gap-2 bg-white dark:bg-slate-800 px-4 py-2 rounded-xl shadow hover:shadow-md transition">
                <span class="text-yellow-600 dark:text-yellow-400 font-bold">{{ pending_leaves }}</span>
                <span class="text-slate-600 dark:text-slate-400">Pending Deferment Requests</span>
                <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
            </a>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- System Activity Trends -->
    <div
        class="col-span-full bg-white dark:bg-slate-800 p-6 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-xl mb-6">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
            <div>
                <h3 class="font-bold text-slate-900 dark:text-white flex items-center gap-2 text-lg">
                    <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                    </svg>
                    System Activity Trends
                </h3>
                <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Operational activity across all modules</p>
            </div>
            <div class="flex items-center bg-slate-100 dark:bg-slate-900 p-1 rounded-xl self-start md:self-center">
                <button onclick="updateTrendRange('weekly')" id="range-weekly"
                    class="px-4 py-1.5 rounded-lg text-sm font-medium transition-all duration-200 bg-white dark:bg-slate-800 text-blue-600 dark:text-blue-400 shadow-sm">
                    Weekly
                </button>
                <button onclick="updateTrendRange('monthly')" id="range-monthly"
                    class="px-4 py-1.5 rounded-lg text-sm font-medium transition-all duration-200 text-slate-600 dark:text-slate-400 hover:text-blue-600 dark:hover:text-blue-400">
                    Monthly
                </button>
            </div>
        </div>

        <div class="relative h-[400px]">
            <canvas id="systemTrendsChart"></canvas>
        </div>

        <div id="chart-legend-analytics" class="flex flex-wrap gap-2 mt-6 justify-center">
            <!-- Legend will be rendered by JS -->
        </div>
    </div>

    <!-- Charts Row 2 -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Maintenance Status -->
        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-xl">
            <h3 class="font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
                <svg class="w-5 h-5 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                    </path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                Maintenance Status
            </h3>
            <div class="h-64">
                <canvas id="maintenanceStatusChart"></canvas>
            </div>
        </div>

        <!-- Deferment Overview -->
        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-xl">
            <h3 class="font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
                <svg class="w-5 h-5 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                    </path>
                </svg>
                Deferment Overview
            </h3>
            <div class="h-64">
                <canvas id="leaveStatusChart"></canvas>
            </div>
        </div>

        <!-- Room Occupancy -->
        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-xl">
            <h3 class="font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
                <svg class="w-5 h-5 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4">
                    </path>
                </svg>
                Room Occupancy
            </h3>
            <div class="flex items-center justify-center h-64">
                <div class="text-center">
                    <div class="relative w-40 h-40 mx-auto">
                        <canvas id="roomOccupancyChart"></canvas>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <div>
                                <p class="text-3xl font-bold text-slate-900 dark:text-white">{{
                                    room_stats.occupancy_rate }}%</p>
                                <p class="text-sm text-slate-500 dark:text-slate-400">Occupied</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Recent Maintenance -->
        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-xl">
            <h3 class="font-semibold text-slate-900 dark:text-white mb-4 flex items-center justify-between">
                <span class="flex items-center gap-2">
                    üîß Recent Maintenance
                </span>
                <a href="{% url 'hms:manage_maintenance' %}"
                    class="text-sm text-blue-600 dark:text-blue-400 hover:underline">View All</a>
            </h3>
            <div class="space-y-3">
                {% for m in recent_maintenance %}
                <div class="flex items-start gap-3 p-3 bg-slate-50 dark:bg-slate-900/50 rounded-lg">
                    <span
                        class="{% if m.status == 'pending' %}text-yellow-500{% elif m.status == 'in_progress' %}text-blue-500{% else %}text-green-500{% endif %}">
                        {% if m.status == 'pending' %}üü°{% elif m.status == 'in_progress' %}üîµ{% else %}üü¢{% endif %}
                    </span>
                    <div class="flex-1 min-w-0">
                        <p class="font-medium text-slate-900 dark:text-white text-sm truncate">{{ m.title }}</p>
                        <p class="text-xs text-slate-500 dark:text-slate-400">{{ m.student.user.first_name }} ‚Ä¢ {{
                            m.created_at|date:"M d" }}</p>
                    </div>
                </div>
                {{ empty }}
                <p class="text-sm text-slate-500 dark:text-slate-400 text-center py-4">No recent maintenance</p>
                {% endfor %}
            </div>
        </div>

        <!-- Recent Leaves -->
        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-xl">
            <h3 class="font-semibold text-slate-900 dark:text-white mb-4 flex items-center justify-between">
                <span class="flex items-center gap-2">
                    üè† Recent Deferment Requests
                </span>
                <a href="{% url 'hms:manage_leave_requests' %}"
                    class="text-sm text-blue-600 dark:text-blue-400 hover:underline">View All</a>
            </h3>
            <div class="space-y-3">
                {% for l in recent_leaves %}
                <div class="flex items-start gap-3 p-3 bg-slate-50 dark:bg-slate-900/50 rounded-lg">
                    <span>
                        {% if l.status == 'pending' %}üü°{% elif l.status == 'approved' %}‚úÖ{% else %}‚ùå{% endif %}
                    </span>
                    <div class="flex-1 min-w-0">
                        <p class="font-medium text-slate-900 dark:text-white text-sm truncate">{{
                            l.student.user.get_full_name }}</p>
                        <p class="text-xs text-slate-500 dark:text-slate-400">{{ l.get_leave_type_display }} ‚Ä¢ {{
                            l.start_date|date:"M d" }}-{{ l.end_date|date:"M d" }}</p>
                    </div>
                </div>
                {{ empty }}
                <p class="text-sm text-slate-500 dark:text-slate-400 text-center py-4">No recent deferment requests</p>
                {% endfor %}
            </div>
        </div>

        <!-- Recent Announcements -->
        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-xl">
            <h3 class="font-semibold text-slate-900 dark:text-white mb-4 flex items-center justify-between">
                <span class="flex items-center gap-2">
                    üì¢ Recent Announcements
                </span>
                <a href="{% url 'hms:manage_announcements' %}"
                    class="text-sm text-blue-600 dark:text-blue-400 hover:underline">View All</a>
            </h3>
            <div class="space-y-3">
                {% for a in recent_announcements %}
                <div class="p-3 bg-slate-50 dark:bg-slate-900/50 rounded-lg">
                    <p class="font-medium text-slate-900 dark:text-white text-sm truncate">{{ a.title }}</p>
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">{{ a.created_at|date:"M d, Y" }} ‚Ä¢ {{
                        a.get_priority_display }}</p>
                </div>
                {{ empty }}
                <p class="text-sm text-slate-500 dark:text-slate-400 text-center py-4">No recent announcements</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const chartData = {{ chart_data_json| safe
    }};
    const isDark = document.documentElement.classList.contains('dark');
    const gridColor = isDark ? '#1e293b' : '#f1f5f9';
    const textColor = isDark ? '#94a3b8' : '#64748b';

    let trendChart = null;
    let currentRange = 'weekly';

    const datasets_config = {
        registrations: { label: 'Registrations', color: '#6366f1', bg: 'rgba(99, 102, 241, 0.1)' },
        payments: { label: 'Payments', color: '#10b981', bg: 'rgba(16, 185, 129, 0.1)' },
        maintenance: { label: 'Maintenance', color: '#ef4444', bg: 'rgba(239, 68, 68, 0.1)' },
        visitors: { label: 'Visitors', color: '#8b5cf6', bg: 'rgba(139, 92, 246, 0.1)' },
        deferments: { label: 'Deferments', color: '#f43f5e', bg: 'rgba(244, 63, 94, 0.1)' },
        breakfasts: { label: 'Breakfasts', color: '#f59e0b', bg: 'rgba(245, 158, 11, 0.1)' },
        suppers: { label: 'Suppers', color: '#0ea5e9', bg: 'rgba(14, 165, 233, 0.1)' },
        away: { label: 'Meals Away', color: '#64748b', bg: 'rgba(100, 116, 139, 0.1)' }
    };

    const activeDatasets = new Set(['registrations', 'payments', 'maintenance', 'visitors', 'deferments', 'breakfasts', 'suppers', 'away']);

    function renderTrendChart() {
        const ctx = document.getElementById('systemTrendsChart').getContext('2d');
        const data = chartData[currentRange];

        const datasets = Object.keys(datasets_config)
            .filter(key => activeDatasets.has(key))
            .map(key => {
                // Map view keys to dataset keys if different
                const dataKey = key === 'breakfasts' ? 'breakfast' : (key === 'suppers' ? 'supper' : key);
                return {
                    label: datasets_config[key].label,
                    data: data[dataKey] || [],
                    borderColor: datasets_config[key].color,
                    backgroundColor: datasets_config[key].bg,
                    borderWidth: 3,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    tension: 0.4,
                    fill: true
                };
            });

        if (trendChart) trendChart.destroy();

        trendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { display: false },
                    tooltip: { backgroundColor: isDark ? '#0f172a' : '#fff', titleColor: isDark ? '#fff' : '#0f172a', bodyColor: isDark ? '#94a3b8' : '#64748b', borderColor: gridColor, borderWidth: 1 }
                },
                scales: {
                    y: { grid: { color: gridColor }, ticks: { color: textColor, precision: 0, stepSize: 1 }, beginAtZero: true },
                    x: { grid: { display: false }, ticks: { color: textColor } }
                }
            }
        });

        renderLegend();
    }

    function renderLegend() {
        const container = document.getElementById('chart-legend-analytics');
        container.innerHTML = '';

        Object.keys(datasets_config).forEach(key => {
            const config = datasets_config[key];
            const isActive = activeDatasets.has(key);

            const btn = document.createElement('button');
            btn.className = `flex items-center gap-2 px-3 py-1.5 rounded-full border transition-all duration-200 text-xs font-semibold ${isActive
                ? 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 shadow-sm opacity-100'
                : 'bg-transparent border-transparent opacity-50 grayscale'
                }`;
            btn.innerHTML = `
                    <span class="w-2.5 h-2.5 rounded-full" style="background-color: ${config.color}"></span>
                    <span class="text-slate-700 dark:text-slate-300">${config.label}</span>
                `;
            btn.onclick = () => {
                if (isActive) activeDatasets.delete(key);
                else activeDatasets.add(key);
                renderTrendChart();
            };
            container.appendChild(btn);
        });
    }

    window.updateTrendRange = function (range) {
        currentRange = range;
        document.getElementById('range-weekly').className = range === 'weekly'
            ? 'px-4 py-1.5 rounded-lg text-sm font-medium transition-all duration-200 bg-white dark:bg-slate-800 text-blue-600 dark:text-blue-400 shadow-sm'
            : 'px-4 py-1.5 rounded-lg text-sm font-medium transition-all duration-200 text-slate-600 dark:text-slate-400 hover:text-blue-600 dark:hover:text-blue-400';
        document.getElementById('range-monthly').className = range === 'monthly'
            ? 'px-4 py-1.5 rounded-lg text-sm font-medium transition-all duration-200 bg-white dark:bg-slate-800 text-blue-600 dark:text-blue-400 shadow-sm'
            : 'px-4 py-1.5 rounded-lg text-sm font-medium transition-all duration-200 text-slate-600 dark:text-slate-400 hover:text-blue-600 dark:hover:text-blue-400';
        renderTrendChart();
    };

    // Initialize Main Trend Chart
    renderTrendChart();

    // Maintenance Status Chart
    new Chart(document.getElementById('maintenanceStatusChart'), {
        type: 'doughnut',
        data: {
            labels: ['Pending', 'In Progress', 'Resolved'],
            datasets: [{
                data: [
                    chartData.maintenance_status.pending,
                    chartData.maintenance_status.in_progress,
                    chartData.maintenance_status.resolved
                ],
                backgroundColor: ['#eab308', '#3b82f6', '#22c55e'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom', labels: { color: textColor, padding: 20 } } }
        }
    });

    // Deferment Overview Chart
    const leaveTypeData = chartData.leave_type || {};
    new Chart(document.getElementById('leaveStatusChart'), {
        type: 'bar',
        data: {
            labels: Object.keys(leaveTypeData),
            datasets: [{
                label: 'Requests',
                data: Object.values(leaveTypeData),
                backgroundColor: 'rgba(16, 185, 129, 0.2)',
                borderColor: '#10b981',
                borderWidth: 2,
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor, precision: 0 } },
                x: { grid: { display: false }, ticks: { color: textColor } }
            }
        }
    });

    // Room Occupancy Chart
    new Chart(document.getElementById('roomOccupancyChart'), {
        type: 'doughnut',
        data: {
            labels: ['Occupied', 'Available'],
            datasets: [{
                data: [chartData.room_occupancy.occupied, chartData.room_occupancy.available],
                backgroundColor: ['#8b5cf6', '#10b981'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '75%',
            plugins: { legend: { display: false } }
        }
    });
    });
</script>
{% endblock %}