{% extends 'hms/base.html' %}
{% load static %}

{% block title %}Kitchen Dashboard{% endblock %}

<style>
    /* Add any specific kitchen dashboard overrides here if needed, 
       but prefer using utility classes in the HTML. */
</style>

{% block content %}
<div class="mb-8">
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold text-slate-900">Kitchen Dashboard ğŸ‘¨â€ğŸ³</h1>
            <p class="text-slate-500">Real-time meal count tracking</p>
        </div>
        <div
            class="flex items-center gap-2 text-sm text-green-600 bg-green-50 px-3 py-1 rounded-full border border-green-200">
            <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
            <span>Auto-refreshing every 30s</span>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-200">
            <div class="text-xl font-bold text-slate-800 mb-0.5">{{ total_students }}</div>
            <div class="text-[10px] font-medium text-slate-500 uppercase tracking-wide">Total Students</div>
        </div>

        <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-200">
            <div class="text-xl font-bold text-amber-600 mb-0.5">{{ students_away }}</div>
            <div class="text-[10px] font-medium text-slate-500 uppercase tracking-wide">Students Away</div>
        </div>

        <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-200">
            <div class="text-xl font-bold text-blue-600 mb-0.5">{{ total_students|add:"-"|add:students_away }}</div>
            <div class="text-[10px] font-medium text-slate-500 uppercase tracking-wide">Students Present</div>
        </div>
    </div>
</div>

<!-- Today's Meals -->
<div class="flex justify-between items-center mb-4">
    <h2 class="text-xl font-bold text-slate-800">Today's Meals - {{ today|date:"l, F d" }}</h2>
    <a href="{% url 'hms:daily_report' %}?date={{ today }}"
        class="text-sm font-bold text-blue-600 hover:text-blue-800 hover:underline">View Report â†’</a>
</div>

<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8" id="todayMeals">
    <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-200 text-center hover:shadow-md transition">
        <div class="text-2xl mb-1">ğŸŒ…</div>
        <div class="text-xl font-bold text-slate-800 mb-0.5" id="today-breakfast">{{ today_breakfast }}</div>
        <div class="text-[10px] font-bold text-slate-600 uppercase tracking-wide">Breakfast</div>
        <div class="text-[10px] text-slate-400 mt-0.5">8:00 - 9:00 AM</div>
        {% if today_early_breakfast > 0 %}
        <div
            class="mt-2 bg-amber-50 text-amber-700 text-[10px] font-bold py-0.5 px-2 rounded border border-amber-200 inline-block">
            â° {{ today_early_breakfast }} early
        </div>
        {% endif %}
    </div>

    <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-200 text-center hover:shadow-md transition">
        <div class="text-2xl mb-1">â˜€ï¸</div>
        <div class="text-xl font-bold text-slate-800 mb-0.5" id="today-lunch">{{ today_lunch }}</div>
        <div class="text-[10px] font-bold text-slate-600 uppercase tracking-wide">Lunch</div>
        <div class="text-[10px] text-slate-400 mt-0.5">12:00 - 2:00 PM</div>
    </div>

    <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-200 text-center hover:shadow-md transition">
        <div class="text-2xl mb-1">ğŸŒ™</div>
        <div class="text-xl font-bold text-slate-800 mb-0.5" id="today-supper">{{ today_supper }}</div>
        <div class="text-[10px] font-bold text-slate-600 uppercase tracking-wide">Supper</div>
        <div class="text-[10px] text-slate-400 mt-0.5">6:00 - 8:00 PM</div>
    </div>
</div>

<!-- Tomorrow's Meals -->
<div class="flex justify-between items-center mb-4">
    <h2 class="text-xl font-bold text-slate-800">Tomorrow's Meals - {{ tomorrow|date:"l, F d" }}</h2>
    <a href="{% url 'hms:daily_report' %}?date={{ tomorrow }}"
        class="text-sm font-bold text-blue-600 hover:text-blue-800 hover:underline">View Report â†’</a>
</div>

<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8" id="tomorrowMeals">
    <div
        class="bg-white p-3 rounded-xl shadow-sm border border-slate-200 text-center opacity-75 hover:opacity-100 transition">
        <div class="text-2xl mb-1">ğŸŒ…</div>
        <div class="text-xl font-bold text-slate-800 mb-0.5" id="tomorrow-breakfast">{{ tomorrow_breakfast }}</div>
        <div class="text-[10px] font-bold text-slate-600 uppercase tracking-wide">Breakfast</div>
        <div class="text-[10px] text-slate-400 mt-0.5">8:00 - 9:00 AM</div>
        {% if tomorrow_early_breakfast > 0 %}
        <div
            class="mt-2 bg-amber-50 text-amber-700 text-[10px] font-bold py-0.5 px-2 rounded border border-amber-200 inline-block">
            â° {{ tomorrow_early_breakfast }} early
        </div>
        {% endif %}
    </div>

    <div
        class="bg-white p-3 rounded-xl shadow-sm border border-slate-200 text-center opacity-75 hover:opacity-100 transition">
        <div class="text-2xl mb-1">â˜€ï¸</div>
        <div class="text-xl font-bold text-slate-800 mb-0.5" id="tomorrow-lunch">{{ tomorrow_lunch }}</div>
        <div class="text-[10px] font-bold text-slate-600 uppercase tracking-wide">Lunch</div>
        <div class="text-[10px] text-slate-400 mt-0.5">12:00 - 2:00 PM</div>
    </div>

    <div
        class="bg-white p-3 rounded-xl shadow-sm border border-slate-200 text-center opacity-75 hover:opacity-100 transition">
        <div class="text-2xl mb-1">ğŸŒ™</div>
        <div class="text-xl font-bold text-slate-800 mb-0.5" id="tomorrow-supper">{{ tomorrow_supper }}</div>
        <div class="text-[10px] font-bold text-slate-600 uppercase tracking-wide">Supper</div>
        <div class="text-[10px] text-slate-400 mt-0.5">6:00 - 8:00 PM</div>
    </div>
</div>

<!-- Confirmed Students List -->
<div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mt-8">
    <div class="px-6 py-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
        <h3 class="font-bold text-slate-800">Confirmed Students (Today)</h3>
        <div class="flex gap-2">
            <a href="{% url 'hms:export_meals_csv' %}?date={{ today }}"
                class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded text-green-700 bg-green-100 hover:bg-green-200">
                ğŸ“¥ Export CSV
            </a>
            <a href="{% url 'hms:early_breakfast_list' %}"
                class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded text-amber-700 bg-amber-100 hover:bg-amber-200">
                â° Early Breakfast List
            </a>
        </div>
    </div>
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-slate-100">
            <thead class="bg-slate-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Student
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Room
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                        Breakfast</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Lunch
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Supper
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-slate-100">
                {% for conf in confirmed_students %}
                <tr class="hover:bg-slate-50 transition">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-slate-900">{{ conf.student.user.get_full_name }}</div>
                        <div class="text-xs text-slate-500">{{ conf.student.user.username }}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">{{ conf.student.room_number }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        {% if conf.breakfast %}
                        <span
                            class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">Yes</span>
                        {% if conf.early_breakfast_needed %}
                        <span
                            class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-amber-100 text-amber-800 ml-1">Early</span>
                        {% endif %}
                        {% else %}
                        <span class="text-slate-400">-</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        {% if conf.lunch %}
                        <span
                            class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">Yes</span>
                        {% else %}
                        <span class="text-slate-400">-</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        {% if conf.supper %}
                        <span
                            class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">Yes</span>
                        {% else %}
                        <span class="text-slate-400">-</span>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="px-6 py-8 text-center text-slate-500 italic">
                        No meals confirmed for today yet.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Auto-refresh meal counts every 30 seconds
    setInterval(function () {
        refreshMealCounts('{{ today }}', 'today');
        refreshMealCounts('{{ tomorrow }}', 'tomorrow');
    }, 30000);

    function refreshMealCounts(date, prefix) {
        fetch(`{% url 'hms:meal_count_api' %}?date=${date}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById(`${prefix}-breakfast`).textContent = data.breakfast;
                document.getElementById(`${prefix}-lunch`).textContent = data.lunch;
                document.getElementById(`${prefix}-supper`).textContent = data.supper;
            })
            .catch(error => console.error('Error refreshing counts:', error));
    }
</script>
{% endblock %}